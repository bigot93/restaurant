<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶€ì‚°ê´‘ì—­ì‹œ ë¶€ì‚°ë§›ì§‘ì •ë³´ ì¡°íšŒ (React)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #667eea;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #c33;
        }

        .restaurant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .restaurant-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 4px solid #667eea;
        }

        .restaurant-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .restaurant-name {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .restaurant-info {
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .restaurant-info strong {
            color: #667eea;
            display: inline-block;
            min-width: 80px;
            font-weight: 600;
        }

        .restaurant-info span {
            color: #555;
        }

        .menu-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 5px;
            font-weight: 500;
        }

        .stats {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .stats p {
            font-size: 1.1em;
            color: #555;
            margin: 5px 0;
        }

        .stats strong {
            color: #667eea;
            font-size: 1.2em;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .info-box h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .info-box code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React 18 CDN + Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // API ë¬¸ì„œ: ë¶€ì‚°ë§›ì§‘ì •ë³´ ì„œë¹„ìŠ¤ (getFoodKr)
        const API_KEY = '6963e001ce3b550dc369c2add83fa89a03f5c3bd507e66c147494cd3113c3225';
        const API_URLS = [
            'http://apis.data.go.kr/6260000/FoodService/getFoodKr',
            'https://apis.data.go.kr/6260000/FoodService/getFoodKr'
        ];
        const USE_CORS_PROXY = false;
        const CORS_PROXY = 'https://cors-anywhere.herokuapp.com/';
        const PAGE_SIZE = 12; // ìµœì´ˆ 12ê°œ, ë” ë³´ê¸° ì‹œ 12ê°œì”©

        // XML ì‘ë‹µì„ JSON í˜•íƒœë¡œ ë³€í™˜
        const parseXmlToData = (xmlText) => {
            try {
                const parser = new DOMParser();
                const xml = parser.parseFromString(xmlText, 'text/xml');
                const getText = (tag) => xml.getElementsByTagName(tag)?.[0]?.textContent || '';
                const totalCount = Number(getText('totalCount')) || 0;
                const resultCode = getText('resultCode') || getText('code') || '99';
                const resultMsg = getText('resultMsg') || getText('message') || '';

                const items = Array.from(xml.getElementsByTagName('item')).map((el) => {
                    const read = (tag) => el.getElementsByTagName(tag)?.[0]?.textContent || '';
                    return {
                        UC_SEQ: read('UC_SEQ'),
                        MAIN_TITLE: read('MAIN_TITLE'),
                        GUGUN_NM: read('GUGUN_NM'),
                        LAT: read('LAT'),
                        LNG: read('LNG'),
                        PLACE: read('PLACE'),
                        TITLE: read('TITLE'),
                        SUBTITLE: read('SUBTITLE'),
                        ADDR1: read('ADDR1'),
                        ADDR2: read('ADDR2'),
                        CNTCT_TEL: read('CNTCT_TEL'),
                        HOMEPAGE_URL: read('HOMEPAGE_URL'),
                        USAGE_DAY_WEEK_AND_TIME: read('USAGE_DAY_WEEK_AND_TIME'),
                        RPRSNTV_MENU: read('RPRSNTV_MENU'),
                        MAIN_IMG_NORMAL: read('MAIN_IMG_NORMAL'),
                        MAIN_IMG_THUMB: read('MAIN_IMG_THUMB'),
                        ITEMCNTNTS: read('ITEMCNTNTS'),
                    };
                });

                return {
                    getFoodKr: {
                        header: { code: resultCode, message: resultMsg, resultCode, resultMsg },
                        item: items,
                        totalCount: totalCount || items.length,
                    },
                };
            } catch {
                return null;
            }
        };

        const parseItems = (data) => {
            if (data?.getFoodKr?.item) {
                const items = Array.isArray(data.getFoodKr.item) ? data.getFoodKr.item : [data.getFoodKr.item];
                const total = data.getFoodKr.totalCount || items.length;
                return { items, total };
            }
            if (data?.response?.body?.items?.item) {
                const items = Array.isArray(data.response.body.items.item)
                    ? data.response.body.items.item
                    : [data.response.body.items.item];
                const total = data.response.body.totalCount || items.length;
                return { items, total };
            }
            return { items: [], total: 0 };
        };

        const RestaurantCard = ({ item }) => {
            const mainTitle = item.MAIN_TITLE || '-';
            const title = item.TITLE || '';
            const subtitle = item.SUBTITLE || '';
            const gugun = item.GUGUN_NM || '';
            const addr1 = item.ADDR1 || '';
            const addr2 = item.ADDR2 || '';
            const tel = item.CNTCT_TEL || '';
            const homepage = item.HOMEPAGE_URL || '';
            const hours = item.USAGE_DAY_WEEK_AND_TIME || '';
            const menu = item.RPRSNTV_MENU || '';
            const lat = item.LAT || '';
            const lng = item.LNG || '';
            const desc = item.ITEMCNTNTS || '';
            const img = item.MAIN_IMG_NORMAL || '';

            return (
                <div className="restaurant-card">
                    <div className="restaurant-name">{mainTitle}</div>
                    {subtitle && (
                        <div className="restaurant-info">
                            <strong>ğŸ“Œ ë¶€ì œëª©:</strong><span>{subtitle}</span>
                        </div>
                    )}
                    {title && (
                        <div className="restaurant-info">
                            <strong>ğŸ“ ì œëª©:</strong><span>{title}</span>
                        </div>
                    )}
                    {gugun && (
                        <div className="restaurant-info">
                            <strong>ğŸ˜ï¸ êµ¬êµ°:</strong><span>{gugun}</span>
                        </div>
                    )}
                    {(addr1 || addr2) && (
                        <div className="restaurant-info">
                            <strong>ğŸ“ ì£¼ì†Œ:</strong><span>{addr1} {addr2}</span>
                        </div>
                    )}
                    {tel && (
                        <div className="restaurant-info">
                            <strong>ğŸ“ ì—°ë½ì²˜:</strong><span>{tel}</span>
                        </div>
                    )}
                    {homepage && (
                        <div className="restaurant-info">
                            <strong>ğŸŒ í™ˆí˜ì´ì§€:</strong>
                            <a href={homepage} target="_blank" rel="noreferrer" style={{ color: '#667eea', textDecoration: 'none' }}>{homepage}</a>
                        </div>
                    )}
                    {hours && (
                        <div className="restaurant-info">
                            <strong>ğŸ• ìš´ì˜ì‹œê°„:</strong><span>{hours}</span>
                        </div>
                    )}
                    {menu && (
                        <div className="restaurant-info">
                            <strong>ğŸ´ ëŒ€í‘œë©”ë‰´:</strong><span className="menu-badge">{menu}</span>
                        </div>
                    )}
                    {(lat && lng) && (
                        <div className="restaurant-info">
                            <strong>ğŸ—ºï¸ ì¢Œí‘œ:</strong><span>ìœ„ë„: {lat}, ê²½ë„: {lng}</span>
                        </div>
                    )}
                    {desc && (
                        <div className="restaurant-info">
                            <strong>ğŸ“„ ìƒì„¸ë‚´ìš©:</strong>
                            <span style={{ fontSize: '0.9em', color: '#666', display: 'block', marginTop: 5 }}>
                                {desc.length > 150 ? `${desc.substring(0, 150)}...` : desc}
                            </span>
                        </div>
                    )}
                    {img && (
                        <div className="restaurant-info">
                            <strong>ğŸ–¼ï¸ ì´ë¯¸ì§€:</strong>
                            <a href={img} target="_blank" rel="noreferrer" style={{ color: '#667eea', textDecoration: 'none' }}>ì´ë¯¸ì§€ ë³´ê¸°</a>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [items, setItems] = useState([]);
            const [filteredItems, setFilteredItems] = useState([]);
            const [totalCount, setTotalCount] = useState(0);
            const [visibleCount, setVisibleCount] = useState(PAGE_SIZE);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const sentinelRef = useRef(null);

            useEffect(() => {
                const fetchData = async () => {
                    setLoading(true);
                    setError('');
                    for (const baseUrl of API_URLS) {
                        try {
                            const encodedKey = encodeURIComponent(API_KEY);
                            let page = 1;
                            const pageSize = 500;
                            let allItems = [];
                            let total = 0;

                            while (true) {
                                let url = `${baseUrl}?serviceKey=${encodedKey}&numOfRows=${pageSize}&pageNo=${page}&resultType=json`;
                                if (USE_CORS_PROXY) url = CORS_PROXY + url;

                                const res = await fetch(url, { headers: { Accept: 'application/json' } });
                                const text = await res.text();

                                let data;
                                try {
                                    data = JSON.parse(text);
                                } catch {
                                    data = parseXmlToData(text);
                                    if (!data) throw new Error('JSON/XML íŒŒì‹± ì‹¤íŒ¨');
                                }

                                const header = data.getFoodKr?.header || data.response?.header || data.header;
                                if (header && ((header.code && header.code !== '00') || (header.resultCode && header.resultCode !== '00'))) {
                                    throw new Error(header.message || header.resultMsg || 'API ì˜¤ë¥˜');
                                }

                                const { items, total: t } = parseItems(data);
                                total = t || total;
                                if (items.length === 0) break;

                                allItems = allItems.concat(items);
                                if (allItems.length >= total) break;

                                page += 1;
                            }

                            setItems(allItems);
                            setFilteredItems(allItems);
                            setTotalCount(total || allItems.length);
                            setLoading(false);
                            return;
                        } catch (err) {
                            console.error('API ì‹œë„ ì‹¤íŒ¨:', err);
                            setError(err.message);
                            setLoading(false);
                        }
                    }
                };

                fetchData();
            }, []);

            // items ë³€ê²½ ì‹œ í•„í„° ì´ˆê¸°í™”
            useEffect(() => {
                setFilteredItems(items);
                setVisibleCount(PAGE_SIZE);
            }, [items]);

            const handleSearch = () => {
                const term = searchTerm.trim().toLowerCase();
                if (!term) {
                    setFilteredItems(items);
                    setVisibleCount(PAGE_SIZE);
                    return;
                }
                const filtered = items.filter((item) => {
                    const nameFields = [
                        item.MAIN_TITLE,
                        item.TITLE,
                        item.SUBTITLE,
                        item.PLACE,
                    ].filter(Boolean).join(' ').toLowerCase();
                    const addrFields = [
                        item.ADDR1,
                        item.ADDR2,
                        item.GUGUN_NM,
                    ].filter(Boolean).join(' ').toLowerCase();
                    return nameFields.includes(term) || addrFields.includes(term);
                });
                setFilteredItems(filtered);
                setVisibleCount(PAGE_SIZE);
            };

            const visibleItems = filteredItems.slice(0, visibleCount);
            const canLoadMore = visibleItems.length < filteredItems.length;

            // ì¸í„°ì„¹ì…˜ ì˜µì €ë²„ë¡œ ë¬´í•œ ìŠ¤í¬ë¡¤ êµ¬í˜„ (ë” ë³´ê¸° ë²„íŠ¼ ì œê±°)
            useEffect(() => {
                if (!canLoadMore) return;
                const sentinel = sentinelRef.current;
                if (!sentinel) return;

                const observer = new IntersectionObserver(
                    (entries) => {
                        entries.forEach((entry) => {
                            if (entry.isIntersecting) {
                                setVisibleCount((prev) => Math.min(prev + PAGE_SIZE, items.length));
                            }
                        });
                    },
                    { rootMargin: '200px 0px 200px 0px', threshold: 0.1 }
                );

                observer.observe(sentinel);
                return () => observer.disconnect();
            }, [canLoadMore, filteredItems.length]);

            return (
                <div className="container">
                    <div className="header">
                        <h1>ğŸœ ë¶€ì‚°ê´‘ì—­ì‹œ ë¶€ì‚°ë§›ì§‘ì •ë³´</h1>
                        <p>ë¶€ì‚°ë§›ì§‘ êµ­ë¬¸ ì •ë³´ ì¡°íšŒ ì„œë¹„ìŠ¤ (React)</p>
                    </div>
                    <div className="content">
                        <div style={{ display: 'flex', gap: '10px', marginBottom: '20px', flexWrap: 'wrap' }}>
                            <input
                                type="text"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                onKeyDown={(e) => { if (e.key === 'Enter') handleSearch(); }}
                                placeholder="ì‹ë‹¹ëª… ë˜ëŠ” ì£¼ì†Œë¡œ ê²€ìƒ‰"
                                style={{
                                    flex: '1 1 280px',
                                    padding: '12px 14px',
                                    borderRadius: '8px',
                                    border: '1px solid #ddd',
                                    fontSize: '1em'
                                }}
                            />
                            <button
                                onClick={handleSearch}
                                style={{
                                    padding: '12px 20px',
                                    background: '#667eea',
                                    color: '#fff',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '1em',
                                    boxShadow: '0 4px 10px rgba(0,0,0,0.12)'
                                }}
                            >
                                ê²€ìƒ‰í•˜ê¸°
                            </button>
                        </div>
                        {loading && <div className="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>}
                        {error && <div className="error">{error}</div>}
                        {!loading && !error && (
                            <>
                        <div className="stats">
                            <p>
                                <strong>ì´ {totalCount}ê°œ</strong>
                                {searchTerm.trim()
                                    ? <> Â· ê²€ìƒ‰ê²°ê³¼ <strong>{filteredItems.length}ê°œ</strong></>
                                    : null}
                                Â· í™”ë©´ì— <strong>{visibleItems.length}ê°œ</strong> í‘œì‹œ
                            </p>
                        </div>
                                <div className="restaurant-grid" style={{ gridTemplateColumns: 'repeat(3, minmax(250px, 1fr))' }}>
                                    {visibleItems.map(item => (
                                        <RestaurantCard key={item.UC_SEQ || item.MAIN_TITLE || item.TITLE} item={item} />
                                    ))}
                                </div>
                                <div ref={sentinelRef} style={{ height: '1px' }} />
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

